const gps=new GPS;const rawLines=[];const MAX_LINES=100;const GSVstate={};const charts={};function createChart(t){ctx=document.getElementById(t).getContext("2d");return new Chart(ctx,{type:"bar",data:{labels:[],datasets:[{label:"GPS SNR (dB-Hz)",data:[]}]},options:{animation:false,responsive:true,scales:{y:{min:0,max:60,title:{display:true,text:"SNR"}},x:{title:{display:true,text:"Satelites"}}}}})}function updateGPSChart(){for(const t in GSVstate){const e=Object.entries(GSVstate[t]).sort((t,e)=>t[0].localeCompare(e[0]));charts[t].data.labels=e.map(t=>t[0]);charts[t].data.datasets[0].data=e.map(t=>t[1]);charts[t].update()}}function createCanvas(t){const e=document.getElementById("charts");const n=document.createElement("div");n.style.marginBottom="24px";const o=document.createElement("h2");o.textContent=t;n.appendChild(o);const a=document.createElement("canvas");a.id=t;a.height=200;a.width=400;n.appendChild(a);e.appendChild(n)}const addGSVPage=(t,e)=>{if(GSVstate[t.system]===undefined){GSVstate[t.system]={};createCanvas(t.system);charts[t.system]=createChart(t.system)}if(GSVstate[t.system][t.key]===undefined){GSVstate[t.system][t.key]=0}if(!t.snr)return;GSVstate[t.system][t.key]=t.snr};gps.on("data",function(t){if(t.type==="GSV"){t.satellites.forEach(addGSVPage)}if(t.type==="GGA"&t.valid){document.getElementById("time").textContent=t.time;document.getElementById("lat").textContent=t.lat!==null?t.lat.toFixed(6):"–";document.getElementById("lon").textContent=t.lon!==null?t.lon.toFixed(6):"–";document.getElementById("fix").textContent=t.fix!==null?t.fix:"–";t:if(t.hdop!==null){document.getElementById("hdop").textContent=t.hdop;if(t.hdop<1){document.getElementById("hdop_mnemonic").textContent="ideal";break t}if(t.hdop<2){document.getElementById("hdop_mnemonic").textContent="excelent";break t}if(t.hdop<5){document.getElementById("hdop_mnemonic").textContent="good";break t}if(t.hdop<10){document.getElementById("hdop_mnemonic").textContent="moderate";break t}if(t.hdop<20){document.getElementById("hdop_mnemonic").textContent="fair";break t}document.getElementById("hdop_mnemonic").textContent="poor";break t}else{document.getElementById("hdop").textContent="-"}document.getElementById("sats").textContent=t.satellites!==null?t.satellites:"–"}});async function pollNMEA(){try{const t=await fetch("/nmea",{cache:"no-store"});if(!t.ok)return;const e=await t.text();const n=e.trim().split("\n");for(const a of n){if(!a.startsWith("$"))continue;rawLines.push(a);gps.update(a);if(rawLines.length>MAX_LINES){rawLines.shift()}}const o=document.getElementById("raw");o.textContent=rawLines.join("\n");o.scrollTop=o.scrollHeight}catch(t){console.log("NMEA fetch failed")}}window.addEventListener("DOMContentLoaded",()=>{setInterval(pollNMEA,1e3);setInterval(updateGPSChart,5e3)});